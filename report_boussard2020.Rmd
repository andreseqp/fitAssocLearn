---
title: "Exploring why the models do not fit Boussard 2020 data so well"
author: "Andrés E. Quiñones"
date: "`r Sys.Date()`"
output:
  pdf_document:
    keep_tex: yes
    latex_engine: xelatex
  word_document: default
keep_tex: yes
fig_caption: yes
editor_options:
  markdown:
    wrap: 80
header-includes:
  - \usepackage{float}
  - \floatplacement{figure}{H}
bibliography: fit_assoc_learn.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE,warning = FALSE,
                      out.extra = "",fig.align = "left")
library(here)
library(ggplot2)
library(cowplot)
library(tidyverse)
library(data.table)
library(knitr)
library(bayesplot)
library(stringi)
library(cmdstanr)
stan_path <- here("..","cmdstan","cmdstan-2.32.2")
set_cmdstan_path(stan_path)
theme_set(new = theme_classic())

```

## The Boussard *et al* data set

In here I present the statistical model used to estimate reinforcement learning 
parameters from data from a reversal learning task. In the experimental set up,
individuals from two experimental treatments are trained to pick one of two stimuli. 
Where one of those two options provides reward in the form of food pellets. 
The experiments is composed of 11 reversal blocks, each of these blocks is composed
of 30 trial. In other words, every 30 trials the stimulus that provides reward 
is switched. Thus, individuals must reverse their estimate of reward in order to make 
adaptive decisions and choose the rewarding stimulus. In figure \ref{fig:plotBoussard}, 
I show the proportion of correct choices for both treatment groups along the trials,
and reversal blocks. 


```{r plotBoussard,fig.show='hold',fig.cap='The Boussard *et al* data-set. Points show the proportion of successes achieved by individuals of both treatment groups along trials and reversal blocks.'}

source(here("plotBoussard.R"))
# png("boussard_data.png")
boussard_data %>% mutate(brainsize=as.factor(brainsize)) %>% 
  ggplot(aes(y=success,x=trial,col=brainsize))+
    stat_summary(fun = mean,geom = "point")+
    stat_summary(fun = mean,geom = "line")+
    # geom_point()+
    facet_grid(brainsize~reversal)+
    theme(legend.position = c(0.8,0.5),
          legend.direction = "horizontal",
          strip.text.y = element_blank())+
    scale_x_continuous(breaks=c(1,15,30))+
    guides(fill=guide_legend(title="Brain size"))+
    
    ggtitle("Repeated reversal vs brainsize")
# dev.off()
# include_graphics("images/boussard_data.png")


```

## Fitting the model with the initial block

```{r}
## Shortening the data-set -----------------------------------------------------
## Let's try to find out why the model with flexible learning rates 
# does not fit the Boussard data set so well.

boussard_data_short <- boussard_data[reversal==0,]

# get number of individuals
Nind <- boussard_data_short[,tankID] %>% unique() %>% length()

# get number of treatment groups
Ntreat <- boussard_data_short[,brainsize] %>% unique() %>% length()

# get total number of trials (including all reversals)
Ntrials <- boussard_data_short[,interaction(trial,reversal)] %>%
  unique() %>% length()

setorder(boussard_data_short,tankID,reversal,trial)

# get the treatment for all individuals
treat_Inds <- boussard_data_short[,unique(brainsize),by=tankID][,V1]

# set the reversal structure
block_r <-cbind(c(rep(c(0,1),each=30,
                      times=6)[1:dim(boussard_data_short[tankID==1])[1]]),
                c(rep(c(1,0),each=30,
                      times=6)[1:dim(boussard_data_short[tankID==1])[1]]))


# Get a unique ID for trials along the reversal blocks
boussard_data_short[,trial.long:=interaction(reversal,trial)]

# Set NA as failure to choose the rewarding option
boussard_data_short[is.na(success),success:=0]

# Transform the success variable, to fit stan model
boussard_wide<-dcast(boussard_data_short[,.(trial.long,tankID,success)],
                     trial.long~tankID,value.var = "success")

boussard_wide[,trial.long:=NULL]

boussard_wide<-t(boussard_wide)

str(boussard_wide)

boussard_RW_cmd<-cmdstan_model(here("stanModels","boussard_RW_mis.stan"))

dim(block_r)

# sample from posterior
fit_boussard_RW_short <- boussard_RW_cmd$sample(list(N=Nind,B=Ntreat,Tr=Ntrials,
                                                   block_r=block_r,
                                                   treat_ID=treat_Inds,
                                                   y=boussard_wide),
                                              parallel_chains = getOption("mc.cores", 5),
                                              chains = 5)

# Save samples to file
# fit_boussard_RW_short$save_object(file = "fit_boussard_stan_short.RDS")
#
# fit_boussard_RW_short<-readRDS("fit_boussard_stan_short.RDS")

# Use shinystan to evaluate the performance of the model
# launch_shinystan(fit_boussard_RW_short)

pars2plot <- c("tau", "mu_alpha", "alphasT[1]", "alphasT[2]",
                "sigma_a")

posteriors<-fit_boussard_RW_short$draws(
  variables = pars2plot)


# png("boussard_mcmc_short.png")
interv<-mcmc_intervals(posteriors)
# dev.off()

preds <- fit_boussard_RW_short$draws(variables = "y_pred")

preds_df <- posterior::as_draws_df(preds)

preds_long <- reshape2::melt(preds_df,id=c('.chain','.iteration'),
                   measure.vars=grep("y_pred",colnames(preds_df)))

rm(list=c("preds","preds_df"))

preds_long <- as.data.table(preds_long)

preds_long[,c("individual","trial"):=tstrsplit(variable,",")]

preds_long[,variable:=NULL]

preds_long[,`:=`(individual=parse_number(individual),
                 trial=parse_number(trial))]

preds_long[,treatment:=as.factor(ifelse(individual<50,0,1))]


# Average over de MCMC samples
mean_ind <- preds_long[,mean(value),by=.(.chain,.iteration,treatment,trial)]

rm(list="preds_long")


mean_ind <-mean_ind %>%
  mutate(reversal= as.integer((trial-1)/30)) %>%
  mutate(RTrial=((trial-1) %% 30)+1)

# mean_ind[,reversal:=reversal+1]

colnames(mean_ind) <- c("chain","iteration","brainsize","Ttrial","success",
                        "reversal","trial")


# png("boussard_ppchecks.png")
ppchecks <-boussard_data_short %>% mutate(brainsize=as.factor(brainsize)) %>%
  ggplot(aes(y=success,x=trial,col=brainsize))+
    stat_summary(fun = mean,geom = "point")+
    stat_summary(fun = mean,geom = "line")+
    # geom_point()+
    theme(legend.position = c(0.5,0.6),
          legend.direction = "horizontal",
          strip.text.y = element_blank())+
    scale_x_continuous(breaks=c(1,15,30))+
    guides(fill=guide_legend(title="Brain size"))+
    ggtitle("Repeated reversal vs brainsize")+
    facet_grid(brainsize~reversal)+
    stat_summary(data=mean_ind,aes(x=trial,y=success,col=as.factor(brainsize)),
                 geom="ribbon",alpha = 0.2,fun.max = function(x){
      quantile(x,0.95)},
      fun.min = function(x){
      quantile(x,0.05)},colour=NA)+
    stat_summary(data=mean_ind,aes(x=trial,y=success,col=as.factor(brainsize)),
                 geom="ribbon",alpha = 0.5,fun.max = function(x){
      quantile(x,0.75)},
      fun.min = function(x){
      quantile(x,0.25)},colour=NA)+
    facet_grid(brainsize~reversal)
dev.off()
png(here('images','Boussard_short_0_alpha.png'))
cowplot::plot_grid(interv,ppchecks)
dev.off()

include_graphics(here('images','Boussard_short_0_alpha.png'))

```
## The initial block with a model that allows flexible learning rates
```{r}

## Shortened data-set with flexible learning rates -----------------------------

# get number of individuals
# Nind <- boussard_data_short[,tankID] %>% unique() %>% length()
# 
# # get number of treatment groups
# Ntreat <- boussard_data_short[,brainsize] %>% unique() %>% length()
# 
# # get total number of trials (including all reversals)
# Ntrials <- boussard_data_short[,interaction(trial,reversal)] %>%
#   unique() %>% length()
# 
# Nrev <- boussard_data_short[,reversal] %>%
#   unique() %>% length()
# 
# NtriRev <- Ntrials/Nrev
# 
# setorder(boussard_data_short,tankID,reversal,trial)
# 
# # get the treatment for all individuals
# treat_Inds <- boussard_data_short[,unique(brainsize),by=tankID][,V1]
# 
# # set the reversal structure
# block_r <-cbind(c(rep(c(0,1),each=30,
#                       times=6)[1:dim(boussard_data_short[tankID==1])[1]]),
#                 c(rep(c(1,0),each=30,
#                       times=6)[1:dim(boussard_data_short[tankID==1])[1]]))
# 
# 
# # Get a unique ID for trials along the reversal blocks
# boussard_data_short[,trial.long:=interaction(reversal,trial)]
# 
# # Set NA as failure to choose the rewarding option
# boussard_data_short[is.na(success),success:=0]
# 
# # Transform the success variable, to fit stan model
# boussard_wide<-dcast(boussard_data_short[,.(trial.long,tankID,success)],
#                      trial.long~tankID,value.var = "success")
# 
# boussard_wide[,trial.long:=NULL]
# 
# boussard_wide<-t(boussard_wide)
# 
# 
# # Compile stan model with random alpha
# boussard_RW_rev<-cmdstan_model(here("stanModels","boussard_RW_rev.stan"))
# 
# 
# # sample from posterior
# fit_boussard_RW_rev_short <- boussard_RW_rev$sample(list(N=Nind,B=Ntreat,Tr=NtriRev,
#                                                    Rev=Nrev,TotTr=Ntrials,
#                                                    block_r=block_r,treat_ID=treat_Inds,
#                                                    y=boussard_wide),
#                                               parallel_chains = getOption("mc.cores", 5),
#                                               chains = 5)
# 
# # Save samples to file
# fit_boussard_RW_rev_short$save_object(file = "fit_boussard_rev_short.RDS")
# 
# fit_boussard_RW_rev_short<-readRDS("fit_boussard_rev_short.RDS")
# 
# 
# pars2plot <- c("tau", "mu_alpha", "alphasT[1]", "alphasT[2]",
#                 "sigma_a")
# 
# posteriors<-fit_boussard_RW_rev_short$draws(
#   variables = pars2plot)
# 
# posteriorsRev <- fit_boussard_RW_rev_short$draws(variables = "alphasRev")
# 
# # png("boussard_mcmc_interv_rev.png")
# interv <- cowplot::plot_grid(mcmc_intervals(posteriors),
#                    mcmc_intervals(posteriorsRev),nrow = 2)
# # dev.off()
# 
# preds <- fit_boussard_RW_rev_short$draws(variables = "y_pred")
# 
# preds_df <- posterior::as_draws_df(preds)
# 
# preds_long <- reshape2::melt(preds_df,id=c('.chain','.iteration'),
#                              measure.vars=grep("y_pred",colnames(preds_df)))
# 
# rm(list=c("preds","preds_df"))
# 
# preds_long <- as.data.table(preds_long)
# 
# preds_long[,c("individual","trial"):=tstrsplit(variable,",")]
# 
# preds_long[,variable:=NULL]
# 
# preds_long[,`:=`(individual=parse_number(individual),
#                  trial=parse_number(trial))]
# 
# preds_long[,treatment:=as.factor(ifelse(individual<50,0,1))]
# 
# 
# # Average over de MCMC samples
# mean_ind <- preds_long[,mean(value),by=.(.chain,.iteration,treatment,trial)]
# 
# rm(list="preds_long")
# 
# 
# mean_ind <-mean_ind %>%
#   mutate(reversal= as.integer((trial-1)/30)) %>%
#   mutate(RTrial=((trial-1) %% 30)+1)
# 
# colnames(mean_ind) <- c("chain","iteration","brainsize","Ttrial","success",
#                         "reversal","trial")


# png(here("images","boussard_short_0_rev.png"))

# cowplot::plot_grid(ncol = 2,
#  interv,
#   boussard_data_short %>% mutate(brainsize=as.factor(brainsize)) %>%
#     ggplot(aes(y=success,x=trial,col=brainsize))+
#     stat_summary(fun = mean,geom = "point")+
#     stat_summary(fun = mean,geom = "line")+
#     # geom_point()+
#     theme(legend.position = c(0.3,0.6),
#           legend.direction = "horizontal",
#           strip.text.y = element_blank())+
#     scale_x_continuous(breaks=c(1,15,30))+
#     guides(fill=guide_legend(title="Brain size"))+
#     ggtitle("Repeated reversal vs brainsize")+
#     facet_grid(brainsize~reversal)+
#     stat_summary(data=mean_ind,aes(x=trial,y=success,col=as.factor(brainsize)),
#                  geom="ribbon",alpha = 0.2,fun.max = function(x){
#                    quantile(x,0.95)},
#                  fun.min = function(x){
#                    quantile(x,0.05)},colour=NA)+
#     stat_summary(data=mean_ind,aes(x=trial,y=success,col=as.factor(brainsize)),
#                  geom="ribbon",alpha = 0.5,fun.max = function(x){
#                    quantile(x,0.75)},
#                  fun.min = function(x){
#                    quantile(x,0.25)},colour=NA)+
#     facet_grid(brainsize~reversal)
# )
# 
# dev.off()

include_graphics(here("images","boussard_short_0_rev.png"))

```

## The initial block with a model that allows flexible learning rates for two blocks
```{r}

# ## Shortened data-set with flexible learning rates -----------------------------
# boussard_data_short <- boussard_data[reversal<2,]
# 
# # get number of individuals
# Nind <- boussard_data_short[,tankID] %>% unique() %>% length()
# #
# # # get number of treatment groups
# Ntreat <- boussard_data_short[,brainsize] %>% unique() %>% length()
# #
# # # get total number of trials (including all reversals)
# Ntrials <- boussard_data_short[,interaction(trial,reversal)] %>%
#   unique() %>% length()
# 
# Nrev <- boussard_data_short[,reversal] %>%
#   unique() %>% length()
# 
# NtriRev <- Ntrials/Nrev
# 
# setorder(boussard_data_short,tankID,reversal,trial)
# 
# # get the treatment for all individuals
# treat_Inds <- boussard_data_short[,unique(brainsize),by=tankID][,V1]
# 
# # set the reversal structure
# block_r <-cbind(c(rep(c(0,1),each=30,
#                       times=6)[1:dim(boussard_data_short[tankID==1])[1]]),
#                 c(rep(c(1,0),each=30,
#                       times=6)[1:dim(boussard_data_short[tankID==1])[1]]))
# 
# 
# # Get a unique ID for trials along the reversal blocks
# boussard_data_short[,trial.long:=interaction(reversal,trial)]
# 
# # Set NA as failure to choose the rewarding option
# boussard_data_short[is.na(success),success:=0]
# 
# # Transform the success variable, to fit stan model
# boussard_wide<-dcast(boussard_data_short[,.(trial.long,tankID,success)],
#                      trial.long~tankID,value.var = "success")
# 
# boussard_wide[,trial.long:=NULL]
# 
# boussard_wide<-t(boussard_wide)
# 
# 
# # Compile stan model with random alpha
# boussard_RW_rev<-cmdstan_model(here("stanModels","boussard_RW_rev.stan"))
# 
# 
# # sample from posterior
# fit_boussard_RW_rev_short <- boussard_RW_rev$sample(list(N=Nind,B=Ntreat,Tr=NtriRev,
#                                                    Rev=Nrev,TotTr=Ntrials,
#                                                    block_r=block_r,treat_ID=treat_Inds,
#                                                    y=boussard_wide),
#                                               parallel_chains = getOption("mc.cores", 5),
#                                               chains = 5)
# 
# # Save samples to file
# # fit_boussard_RW_rev_short$save_object(file = "fit_boussard_rev_short.RDS")
# # 
# # fit_boussard_RW_rev_short<-readRDS("fit_boussard_rev_short.RDS")
# 
# 
# pars2plot <- c("tau", "mu_alpha", "alphasT[1]", "alphasT[2]",
#                 "sigma_a")
# 
# posteriors<-fit_boussard_RW_rev_short$draws(
#   variables = pars2plot)
# 
# posteriorsRev <- fit_boussard_RW_rev_short$draws(variables = "alphasRev")
# 
# # png("boussard_mcmc_interv_rev.png")
# interv <- cowplot::plot_grid(mcmc_intervals(posteriors),
#                    mcmc_intervals(posteriorsRev),nrow = 2)
# # dev.off()
# 
# preds <- fit_boussard_RW_rev_short$draws(variables = "y_pred")
# 
# preds_df <- posterior::as_draws_df(preds)
# 
# preds_long <- reshape2::melt(preds_df,id=c('.chain','.iteration'),
#                              measure.vars=grep("y_pred",colnames(preds_df)))
# 
# rm(list=c("preds","preds_df"))
# 
# preds_long <- as.data.table(preds_long)
# 
# preds_long[,c("individual","trial"):=tstrsplit(variable,",")]
# 
# preds_long[,variable:=NULL]
# 
# preds_long[,`:=`(individual=parse_number(individual),
#                  trial=parse_number(trial))]
# 
# preds_long[,treatment:=as.factor(ifelse(individual<50,0,1))]
# 
# 
# # Average over de MCMC samples
# mean_ind <- preds_long[,mean(value),by=.(.chain,.iteration,treatment,trial)]
# 
# rm(list="preds_long")
# 
# 
# mean_ind <-mean_ind %>%
#   mutate(reversal= as.integer((trial-1)/30)) %>%
#   mutate(RTrial=((trial-1) %% 30)+1)
# 
# colnames(mean_ind) <- c("chain","iteration","brainsize","Ttrial","success",
#                         "reversal","trial")


# png(here("images","boussard_short_01_rev.png"))

# cowplot::plot_grid(nrow  = 2,
#  interv,
#   boussard_data_short %>% mutate(brainsize=as.factor(brainsize)) %>%
#     ggplot(aes(y=success,x=trial,col=brainsize))+
#     stat_summary(fun = mean,geom = "point")+
#     stat_summary(fun = mean,geom = "line")+
#     # geom_point()+
#     # theme(legend.position = c(0.3,0.6),
#     #       legend.direction = "horizontal",
#     #       strip.text.y = element_blank())+
#     scale_x_continuous(breaks=c(1,15,30))+
#     guides(fill=FALSE)+
#     ggtitle("Repeated reversal vs brainsize")+
#     facet_grid(brainsize~reversal)+
#     stat_summary(data=mean_ind,aes(x=trial,y=success,col=as.factor(brainsize)),
#                  geom="ribbon",alpha = 0.2,fun.max = function(x){
#                    quantile(x,0.95)},
#                  fun.min = function(x){
#                    quantile(x,0.05)},colour=NA)+
#     stat_summary(data=mean_ind,aes(x=trial,y=success,col=as.factor(brainsize)),
#                  geom="ribbon",alpha = 0.5,fun.max = function(x){
#                    quantile(x,0.75)},
#                  fun.min = function(x){
#                    quantile(x,0.25)},colour=NA)+
#     facet_grid(brainsize~reversal)
# )

# dev.off()

include_graphics(here("images","boussard_short_01_rev.png"))

```


## Fitting a model with the temperature parameter as a fixed effect

```{r}
## shortened data-set with tau as a fixed effect ------------------------------

# boussard_data_short <- boussard_data[reversal<1,]
# 
# # get number of individuals
# Nind <- boussard_data_short[,tankID] %>% unique() %>% length()
# 
# # get number of treatment groups
# Ntreat <- boussard_data_short[,brainsize] %>% unique() %>% length()
# 
# # get total number of trials (including all reversals)
# Ntrials <- boussard_data_short[,interaction(trial,reversal)] %>% 
#   unique() %>% length()
# 
# setorder(boussard_data_short,tankID,reversal,trial)
# 
# # get the treatment for all individuals
# treat_Inds <- boussard_data_short[,unique(brainsize),by=tankID][,V1]  
# 
# # set the reversal structure 
# block_r <-cbind(c(rep(c(0,1),each=30,
#                       times=6)[1:dim(boussard_data_short[tankID==1])[1]]),
#                 c(rep(c(1,0),each=30,
#                       times=6)[1:dim(boussard_data_short[tankID==1])[1]]))
# 
# 
# # Get a unique ID for trials along the reversal blocks
# boussard_data_short[,trial.long:=interaction(reversal,trial)]
# 
# # Set NA as failure to choose the rewarding option
# boussard_data_short[is.na(success),success:=0]
# 
# # Transform the success variable, to fit stan model
# boussard_wide<-dcast(boussard_data_short[,.(trial.long,tankID,success)],
#                      trial.long~tankID,value.var = "success")
# 
# boussard_wide[,trial.long:=NULL]
# 
# boussard_wide<-t(boussard_wide)
# 
# str(boussard_wide)
# 
# boussard_RW_tau<-cmdstan_model(here("stanModels","boussard_RW_tau.stan"))
# 
# dim(block_r)
# 
# # sample from posterior
# fit_boussard_RW_short_tau <- boussard_RW_tau$sample(list(N=Nind,B=Ntreat,Tr=Ntrials,
#                                                      block_r=block_r,
#                                                      treat_ID=treat_Inds,
#                                                      y=boussard_wide),
#                                                 parallel_chains = getOption("mc.cores", 5),
#                                                 chains = 5)
# 
# # Save samples to file
# fit_boussard_RW_short_tau$save_object(file = "fit_boussard_stan_short_tau.RDS")
# 
# fit_boussard_RW_short_tau<-readRDS("fit_boussard_stan_short_tau.RDS")
# 
# # Use shinystan to evaluate the performance of the model
# # launch_shinystan(fit_boussard_RW_short_tau)
# 
# pars2plot <- c("alpha", "mu_tau", "tausT[1]", "tausT[2]",
#                "sigma_t")
# 
# posteriors<-fit_boussard_RW_short_tau$draws(
#   variables = pars2plot)
# 
# 
# preds <- fit_boussard_RW_short_tau$draws(variables = "y_pred")
# 
# preds_df <- posterior::as_draws_df(preds)
# 
# preds_long <- reshape2::melt(preds_df,id=c('.chain','.iteration'),
#                              measure.vars=grep("y_pred",colnames(preds_df)))
# 
# rm(list=c("preds","preds_df"))
# 
# preds_long <- as.data.table(preds_long)
# 
# preds_long[,c("individual","trial"):=tstrsplit(variable,",")]
# 
# preds_long[,variable:=NULL]
# 
# preds_long[,`:=`(individual=parse_number(individual),
#                  trial=parse_number(trial))]
# 
# preds_long[,treatment:=as.factor(ifelse(individual<50,0,1))]
# 
# 
# # Average over de MCMC samples
# mean_ind <- preds_long[,mean(value),by=.(.chain,.iteration,treatment,trial)]
# 
# rm(list="preds_long")
# 
# 
# mean_ind <-mean_ind %>%
#   mutate(reversal= as.integer((trial-1)/30)) %>%
#   mutate(RTrial=((trial-1) %% 30)+1)
# 
# colnames(mean_ind) <- c("chain","iteration","brainsize","Ttrial","success",
#                         "reversal","trial")


# png(here('images',"boussard_short_0_tau.png"))
# 
# cowplot::plot_grid(ncol = 2,
#   # png("boussard_mcmc_short.png")
# mcmc_intervals(posteriors),
# boussard_data_short %>% mutate(brainsize=as.factor(brainsize)) %>%
#   ggplot(aes(y=success,x=trial,col=brainsize))+
#   stat_summary(fun = mean,geom = "point")+
#   stat_summary(fun = mean,geom = "line")+
#   # geom_point()+
#   theme(legend.position = c(0.5,0.6),
#         legend.direction = "horizontal",
#         strip.text.y = element_blank())+
#   scale_x_continuous(breaks=c(1,15,30))+
#   guides(fill=guide_legend(title="Brain size"))+
#   ggtitle("Repeated reversal vs brainsize")+
#   facet_grid(brainsize~reversal)+
#   stat_summary(data=mean_ind,aes(x=trial,y=success,col=as.factor(brainsize)),
#                geom="ribbon",alpha = 0.2,fun.max = function(x){
#                  quantile(x,0.95)},
#                fun.min = function(x){
#                  quantile(x,0.05)},colour=NA)+
#   stat_summary(data=mean_ind,aes(x=trial,y=success,col=as.factor(brainsize)),
#                geom="ribbon",alpha = 0.5,fun.max = function(x){
#                  quantile(x,0.75)},
#                fun.min = function(x){
#                  quantile(x,0.25)},colour=NA)+
#   facet_grid(brainsize~reversal)
# )
# dev.off()

include_graphics(here('images',"boussard_short_0_tau.png"))

```

## Fitting a model with different \(\tau\) for each reversal block (just 2 blocks)

```{r}
## Let´s fit a different tau for each reversal block ---------------------------

boussard_data_short <- boussard_data[reversal<2,]

# get number of individuals
Nind <- boussard_data_short[,tankID] %>% unique() %>% length()

# get number of treatment groups
Ntreat <- boussard_data_short[,brainsize] %>% unique() %>% length()

# get total number of trials (including all reversals)
Ntrials <- boussard_data_short[,interaction(trial,reversal)] %>%
  unique() %>% length()

Nrev <- boussard_data_short[,reversal] %>%
  unique() %>% length()

NtriRev <- Ntrials/Nrev

setorder(boussard_data_short,tankID,reversal,trial)

# get the treatment for all individuals
treat_Inds <- boussard_data_short[,unique(brainsize),by=tankID][,V1]

# set the reversal structure
block_r <-cbind(c(rep(c(0,1),each=30,
                      times=6)[1:dim(boussard_data_short[tankID==1])[1]]),
                c(rep(c(1,0),each=30,
                      times=6)[1:dim(boussard_data_short[tankID==1])[1]]))


# Get a unique ID for trials along the reversal blocks
boussard_data_short[,trial.long:=interaction(reversal,trial)]

# Set NA as failure to choose the rewarding option
boussard_data_short[is.na(success),success:=0]

# Transform the success variable, to fit stan model
boussard_wide<-dcast(boussard_data_short[,.(trial.long,tankID,success)],
                     trial.long~tankID,value.var = "success")

boussard_wide[,trial.long:=NULL]

boussard_wide<-t(boussard_wide)

str(boussard_wide)

boussard_RW_tau_rev<-cmdstan_model(here("stanModels","boussard_RW_tau_rev.stan"))

dim(block_r)

# sample from posterior
fit_boussard_RW_short_tau_rev <- boussard_RW_tau_rev$sample(list(N=Nind,B=Ntreat,Tr=NtriRev,
                                                         Rev=Nrev,TotTr=Ntrials,
                                                         block_r=block_r,treat_ID=treat_Inds,
                                                         y=boussard_wide),
                                                    parallel_chains = getOption("mc.cores", 5),
                                                    chains = 5)

# Save samples to file
# fit_boussard_RW_short_tau_rev$save_object(file = "fit_boussard_stan_short_tau_rev.RDS")
# 
# fit_boussard_RW_short_tau_rev<-readRDS("fit_boussard_stan_short_tau_rev.RDS")

# Use shinystan to evaluate the performance of the model
# launch_shinystan(fit_boussard_RW_short_tau_rev)

pars2plot <- c("alpha", "mu_tau", "tausT[1]", "tausT[2]",
               "sigma_t")

posteriors <- fit_boussard_RW_short_tau_rev$draws(variables = pars2plot)
posteriorsRev <- fit_boussard_RW_short_tau_rev$draws(variables = "tausRev")

interv<-cowplot::plot_grid(mcmc_intervals(posteriors),
                   mcmc_intervals(posteriorsRev),ncol = 2)

# png("boussard_mcmc_interv_rev.png")
# dev.off()

preds <- fit_boussard_RW_short_tau_rev$draws(variables = "y_pred")

preds_df <- posterior::as_draws_df(preds)

preds_long <- reshape2::melt(preds_df,id=c('.chain','.iteration'),
                             measure.vars=grep("y_pred",colnames(preds_df)))

rm(list=c("preds","preds_df"))

preds_long <- as.data.table(preds_long)

preds_long[,c("individual","trial"):=tstrsplit(variable,",")]

preds_long[,variable:=NULL]

preds_long[,`:=`(individual=parse_number(individual),
                 trial=parse_number(trial))]

preds_long[,treatment:= treat_Inds[individual]]


# Average over de MCMC samples
mean_ind <- preds_long[,mean(value),by=.(.chain,.iteration,treatment,trial)]

rm(list="preds_long")


mean_ind <-mean_ind %>%
  mutate(reversal= as.integer((trial-1)/30)) %>%
  mutate(RTrial=((trial-1) %% 30)+1)

colnames(mean_ind) <- c("chain","iteration","brainsize","Ttrial","success",
                        "reversal","trial")

ppchecks_plot<-boussard_data_short %>% mutate(brainsize=as.factor(brainsize)) %>%
    ggplot(aes(y=success,x=trial,col=brainsize))+
    stat_summary(fun = mean,geom = "point")+
    stat_summary(fun = mean,geom = "line")+
    # geom_point()+
    # theme(legend.position = c(0.6,0.6),
    #       legend.direction = "vertical",
    #       strip.text.y = element_blank())+
    theme(legend.position = "none")+
    scale_x_continuous(breaks=c(1,15,30))+
    guides(fill=guide_legend(title="Brain size"))+
    ggtitle("Repeated reversal vs brainsize")+
    facet_grid(brainsize~reversal)+
    stat_summary(data=mean_ind,aes(x=trial,y=success,col=as.factor(brainsize)),
                 geom="ribbon",alpha = 0.2,fun.max = function(x){
                   quantile(x,0.95)},
                 fun.min = function(x){
                   quantile(x,0.05)},colour=NA)+
    stat_summary(data=mean_ind,aes(x=trial,y=success,col=as.factor(brainsize)),
                 geom="ribbon",alpha = 0.5,fun.max = function(x){
                   quantile(x,0.75)},
                 fun.min = function(x){
                   quantile(x,0.25)},colour=NA)+
    facet_grid(brainsize~reversal)

png(here('images',"boussard_short_01_tau.png"))
cowplot::plot_grid(nrow = 2,interv,ppchecks_plot)
dev.off()

# include_graphics(here('images',"boussard_short_01_tau.png"))

```
## Fitting a model with a different \(\tau\) and  \(\alpha\) for each reversal block

```{r}
## Let's fit a different tau and alpha for each reversal block -----------------


boussard_data_short <- boussard_data[reversal<3,]

# get number of individuals
Nind <- boussard_data_short[,tankID] %>% unique() %>% length()

# get number of treatment groups
Ntreat <- boussard_data_short[,brainsize] %>% unique() %>% length()

# get total number of trials (including all reversals)
Ntrials <- boussard_data_short[,interaction(trial,reversal)] %>%
  unique() %>% length()

Nrev <- boussard_data_short[,reversal] %>%
  unique() %>% length()

NtriRev <- Ntrials/Nrev

setorder(boussard_data_short,tankID,reversal,trial)

# get the treatment for all individuals
treat_Inds <- boussard_data_short[,unique(brainsize),by=tankID][,V1]

# set the reversal structure
block_r <-cbind(c(rep(c(0,1),each=30,
                      times=6)[1:dim(boussard_data_short[tankID==1])[1]]),
                c(rep(c(1,0),each=30,
                      times=6)[1:dim(boussard_data_short[tankID==1])[1]]))


# Get a unique ID for trials along the reversal blocks
boussard_data_short[,trial.long:=interaction(reversal,trial)]

# Set NA as failure to choose the rewarding option
boussard_data_short[is.na(success),success:=0]

# Transform the success variable, to fit stan model
boussard_wide<-dcast(boussard_data_short[,.(trial.long,tankID,success)],
                     trial.long~tankID,value.var = "success")

boussard_wide[,trial.long:=NULL]

boussard_wide<-t(boussard_wide)

str(boussard_wide)

boussard_RW_tau_alpha_rev<-cmdstan_model(here("stanModels",
                                        "boussard_RW_tau_alpha_rev.stan"))

dim(block_r)

# sample from posterior
fit_boussard_RW_short_tau_alpha_rev <- boussard_RW_tau_alpha_rev$sample(
  list(N=Nind,B=Ntreat,Tr=NtriRev,
           Rev=Nrev,TotTr=Ntrials,#initProp=0.5,
           block_r=block_r,treat_ID=treat_Inds,
           y=boussard_wide),
      parallel_chains = getOption("mc.cores", 5),
      chains = 1,iter_sampling = 200)

# Save samples to file
# fit_boussard_RW_short_tau_alpha_rev$save_object(file =
  # "fit_boussard_stan_short_tau_alpha_rev.RDS")

# fit_boussard_RW_short_tau_alpha_rev<-readRDS("fit_boussard_stan_short_tau_alpha_rev.RDS")

# Use shinystan to evaluate the performance of the model
# launch_shinystan(fit_boussard_RW_short_tau_alpha_rev)

parsTau2plot <- c("tauT1","mus[2]","tausRev")
parsAlpha2plot <- c("mus[1]","alphasRev")
parssigmas2plot <- c("sigmas[1]","sigmas[2]")
# pars2plot <- c("tauT1","mus[1]","mus[2]","sigmas[1]","sigmas[2]")

posteriorsTau <- fit_boussard_RW_short_tau_alpha_rev$draws(variables = parsTau2plot)
posteriorsAlpha <- fit_boussard_RW_short_tau_alpha_rev$draws(variables = parsAlpha2plot)
posteriorsSigma <- fit_boussard_RW_short_tau_alpha_rev$draws(variables = parssigmas2plot)

# png("boussard_mcmc_interv_rev.png")
interv<-cowplot::plot_grid(ncol = 3,mcmc_intervals(posteriorsTau),
                   mcmc_intervals(posteriorsAlpha),
                   mcmc_intervals(posteriorsSigma)
 )
# dev.off()


preds <- fit_boussard_RW_short_tau_alpha_rev$draws(variables = "y_pred")

preds_df <- posterior::as_draws_df(preds)

preds_long <- reshape2::melt(preds_df,id=c('.chain','.iteration'),
                             measure.vars=grep("y_pred",colnames(preds_df)))

rm(list=c("preds","preds_df"))

preds_long <- as.data.table(preds_long)

preds_long[,c("individual","trial"):=tstrsplit(variable,",")]

preds_long[,variable:=NULL]

preds_long[,`:=`(individual=parse_number(individual),
                 trial=parse_number(trial))]

preds_long[,treatment:= treat_Inds[individual]]


# Average over de MCMC samples
mean_ind <- preds_long[,mean(value),by=.(.chain,.iteration,treatment,trial)]

rm(list="preds_long")


mean_ind_01 <-mean_ind %>%
  mutate(reversal= as.integer((trial-1)/30)) %>%
  mutate(RTrial=((trial-1) %% 30)+1)

# mean_ind_1[,reversal:=reversal+1]

colnames(mean_ind_01) <- c("chain","iteration","brainsize","Ttrial","success",
                        "reversal","trial")



ppcheks_plot <- boussard_data_short %>% mutate(brainsize=as.factor(brainsize)) %>%
    ggplot(aes(y=success,x=trial,col=brainsize))+
    stat_summary(fun = mean,geom = "point")+
    stat_summary(fun = mean,geom = "line")+
    geom_hline(yintercept = 0.5)+
    # theme(legend.position = c(0.6,0.6),
    #           legend.direction = "vertical",
    #           strip.text.y = element_blank())+
    theme(legend.position = "none")+
    scale_x_continuous(breaks=c(1,15,30))+
    guides(fill=none)+
    ggtitle("Repeated reversal vs brainsize")+
    facet_grid(brainsize~reversal)+
    stat_summary(data=mean_ind_01,aes(x=trial,y=success,col=as.factor(brainsize)),
                 geom="ribbon",alpha = 0.2,fun.max = function(x){
                   quantile(x,0.95)},
                 fun.min = function(x){
                   quantile(x,0.05)},colour=NA)+
    stat_summary(data=mean_ind_01,aes(x=trial,y=success,col=as.factor(brainsize)),
                 geom="ribbon",alpha = 0.5,fun.max = function(x){
                   quantile(x,0.75)},
                 fun.min = function(x){
                   quantile(x,0.25)},colour=NA)+
    facet_grid(brainsize~reversal)

png(here('images','Boussard_short_alpha_tau_sigma.png'))

cowplot::plot_grid(nrow = 2,
interv,
ppcheks_plot
)

dev.off()

# include_graphics(here('images','Boussard_short_alpha_tau_sigma.png'))
# png("boussard_ppchecks.png")
# cowplot::plot_grid(nrow = 2,
#   boussard_data_short %>% mutate(brainsize=as.factor(brainsize)) %>%
#     ggplot(aes(y=success,x=trial,col=brainsize))+
#     stat_summary(fun = mean,geom = "point")+
#     stat_summary(fun = mean,geom = "line")+
#     geom_hline(yintercept = c(0.5,1))+
#     theme(legend.position = c(0.1,0.6),
#           legend.direction = "horizontal")+
#     scale_x_continuous(breaks=c(1,15,30))+
#     guides(fill=guide_legend(title="Brain size"))+
#     ggtitle("Repeated reversal vs brainsize")+
#     facet_grid(brainsize~reversal)+
#     stat_summary(data=mean_ind_01,aes(x=trial,y=success,col=as.factor(brainsize)),
#                  geom="ribbon",alpha = 0.2,fun.max = function(x){
#                    quantile(x,0.95)},
#                  fun.min = function(x){
#                    quantile(x,0.05)},colour=NA)+
#     stat_summary(data=mean_ind_01,aes(x=trial,y=success,col=as.factor(brainsize)),
#                  geom="ribbon",alpha = 0.5,fun.max = function(x){
#                    quantile(x,0.75)},
#                  fun.min = function(x){
#                    quantile(x,0.25)},colour=NA)+
#     facet_grid(brainsize~reversal),
#     cowplot::plot_grid(boussard_data_short %>% mutate(brainsize=as.factor(brainsize)) %>%
#     filter(reversal==0) %>% 
#     ggplot(aes(y=success,x=trial,col=brainsize))+
#     stat_summary(fun = mean,geom = "point")+
#     stat_summary(fun = mean,geom = "line")+
#     geom_hline(yintercept = c(0.5,1))+
#     theme(legend.position = c(0.3,0.6),
#             legend.direction = "horizontal")+
#       scale_x_continuous(breaks=c(1,15,30))+
#     stat_summary(data=mean_ind_0,aes(x=trial,y=success,col=as.factor(brainsize)),
#                         geom="ribbon",alpha = 0.2,fun.max = function(x){
#                           quantile(x,0.95)},
#                         fun.min = function(x){
#                           quantile(x,0.05)},colour=NA)+
#     stat_summary(data=mean_ind_0,aes(x=trial,y=success,col=as.factor(brainsize)),
#                  geom="ribbon",alpha = 0.5,fun.max = function(x){
#                    quantile(x,0.75)},
#                  fun.min = function(x){
#                    quantile(x,0.25)},colour=NA)+
#     facet_grid(brainsize~reversal),
#     boussard_data_short %>% mutate(brainsize=as.factor(brainsize)) %>%
#     filter(reversal==1) %>% 
#     ggplot(aes(y=success,x=trial,col=brainsize))+
#     stat_summary(fun = mean,geom = "point")+
#     stat_summary(fun = mean,geom = "line")+
#     geom_hline(yintercept = c(0.5,1))+
#     scale_x_continuous(breaks=c(1,15,30))+
#       theme(legend.position = c(0.3,0.6),
#             legend.direction = "horizontal")+
#       
#     stat_summary(data=mean_ind_1,aes(x=trial,y=success,col=as.factor(brainsize)),
#                geom="ribbon",alpha = 0.2,fun.max = function(x){
#                  quantile(x,0.95)},
#                fun.min = function(x){
#                  quantile(x,0.05)},colour=NA)+
#     stat_summary(data=mean_ind_1,aes(x=trial,y=success,col=as.factor(brainsize)),
#                  geom="ribbon",alpha = 0.5,fun.max = function(x){
#                    quantile(x,0.75)},
#                  fun.min = function(x){
#                    quantile(x,0.25)},colour=NA)+
#     facet_grid(brainsize~reversal))
# )

```
## Model with \(\alpha\) with a fixed and random effect allowing missing data

```{r}
## Shortening the data-set -----------------------------------------------------
## Let's try to find out why the model with flexible learning rates 
# does not fit the Boussard data set so well.
# 
boussard_data_short <- boussard_data[reversal==0,]
# 
# # get number of individuals
Nind <- boussard_data_short[,tankID] %>% unique() %>% length()
# 
# # get number of treatment groups
Ntreat <- boussard_data_short[,brainsize] %>% unique() %>% length()
# 
# # get total number of trials (including all reversals)
Ntrials <- boussard_data_short[,interaction(trial,reversal)] %>%
  unique() %>% length()
# 
setorder(boussard_data_short,tankID,reversal,trial)
# 
# # get the treatment for all individuals
treat_Inds <- boussard_data_short[,unique(brainsize),by=tankID][,V1]
# 
# # set the reversal structure 
block_r <-cbind(c(rep(c(0,1),each=30,
  times=6)[1:dim(boussard_data_short[tankID==1])[1]]),
  c(rep(c(1,0),each=30,
  times=6)[1:dim(boussard_data_short[tankID==1])[1]]))


# # Get a unique ID for trials along the reversal blocks
boussard_data_short[,trial.long:=interaction(reversal,trial)]

# # Set NA as failure to choose the rewarding option
boussard_data_short[is.na(success),success:=-1]

boussard_data_short[,unique(interaction(tankID,brainsize))]

# ii_mis <- boussard_data_short[is.na(success),.(tankID,trial)]
# Nmis <- dim(ii_mis)[1]
# 
# ii_obs <- boussard_data_short[!is.na(success),.(tankID,trial)]
# Nobs <- dim(ii_obs)[1]

boussard_data[!is.na(success),]

# Transform the success variable, to fit stan model
boussard_wide<-dcast(boussard_data_short[,.(trial.long,tankID,success)],
    trial.long~tankID,value.var = "success")

boussard_wide[,trial.long:=NULL]

boussard_wide<-t(boussard_wide)

str(boussard_wide)

boussard_RW_cmd<-cmdstan_model(here("stanModels","boussard_RW_mis.stan"))

dim(block_r)

# sample from posterior
fit_boussard_RW_short <- boussard_RW_cmd$sample(list(N=Nind,B=Ntreat,Tr=Ntrials,
                                                   block_r=block_r,
                                                   treat_ID=treat_Inds,
                                                   y=boussard_wide),
                                              parallel_chains = getOption("mc.cores", 5),
                                              chains = 5)

# # Save samples to file
# # fit_boussard_RW_short$save_object(file = "fit_boussard_stan_short.RDS")
# # 
# # fit_boussard_RW_short<-readRDS("fit_boussard_stan_short.RDS")
# 
# # Use shinystan to evaluate the performance of the model
# # launch_shinystan(fit_boussard_RW_short)
# 
pars2plot <- c("tau", "mu_alpha", "alphasT[1]", "alphasT[2]",
                "sigma_a")

posteriors<-fit_boussard_RW_short$draws(
  variables = pars2plot)


# png("boussard_mcmc_short.png")
interv<-mcmc_intervals(posteriors)
# dev.off()

preds <- fit_boussard_RW_short$draws(variables = "y_pred")

preds_df <- posterior::as_draws_df(preds)

preds_long <- reshape2::melt(preds_df,id=c('.chain','.iteration'),
                   measure.vars=grep("y_pred",colnames(preds_df)))

rm(list=c("preds","preds_df"))

preds_long <- as.data.table(preds_long)

preds_long[,c("individual","trial"):=tstrsplit(variable,",")]

preds_long[,variable:=NULL]

preds_long[,`:=`(individual=parse_number(individual),
                 trial=parse_number(trial))]

preds_long[,treatment:=as.factor(ifelse(individual<50,0,1))]


# Average over de MCMC samples
mean_ind <- preds_long[,mean(value),by=.(.chain,.iteration,treatment,trial)]

rm(list="preds_long")


mean_ind <-mean_ind %>%
  mutate(reversal= as.integer((trial-1)/30)) %>%
  mutate(RTrial=((trial-1) %% 30)+1)

# mean_ind[,reversal:=reversal+1]

colnames(mean_ind) <- c("chain","iteration","brainsize","Ttrial","success",
                        "reversal","trial")


# png("boussard_ppchecks.png")
ppchecks <-
  boussard_data_short %>% mutate(brainsize=as.factor(brainsize)) %>%
  ggplot(aes(y=success,x=trial,col=brainsize))+
    stat_summary(fun = mean,geom = "point")+
    stat_summary(fun = mean,geom = "line")+
    # geom_point()+
    theme(legend.position = c(0.5,0.6),
          legend.direction = "horizontal",
          strip.text.y = element_blank())+
    scale_x_continuous(breaks=c(1,15,30))+
    guides(fill=guide_legend(title="Brain size"))+
    ggtitle("Repeated reversal vs brainsize")+
    facet_grid(brainsize~reversal)+
    stat_summary(data=mean_ind,aes(x=trial,y=success,col=as.factor(brainsize)),
                 geom="ribbon",alpha = 0.2,fun.max = function(x){
      quantile(x,0.95)},
      fun.min = function(x){
      quantile(x,0.05)},colour=NA)+
    stat_summary(data=mean_ind,aes(x=trial,y=success,col=as.factor(brainsize)),
                 geom="ribbon",alpha = 0.5,fun.max = function(x){
      quantile(x,0.75)},
      fun.min = function(x){
      quantile(x,0.25)},colour=NA)+
    facet_grid(brainsize~reversal)
dev.off()
# png(here('images','Boussard_short_0_alpha.png'))
cowplot::plot_grid(interv,ppchecks)
# dev.off()

include_graphics(here('images','Boussard_short_0_alpha.png'))

```

